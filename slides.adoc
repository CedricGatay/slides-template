= Docker Jenkins Slave
:author: Cedric Gatay
:keywords: @Cedric_Gatay #Tours_Jug
:email: c.gatay@code-troopers.com
:backend: deckjs
:customcss: ct/ct.css
:customjs: ct/ct.js
:deckjs_transition: horizontal-slide
:goto:
:menu:
:status:

// T'es qui ?
== Qui
Freelance

Code-Troopers

BrownBagLunch

Packt publishing

== Jenkins
Serveur d'intégration continue

Permet de piloter des noeuds

 * WMI + DCOM
 * JNLP
 * SSH

== Raisons 
// Pourquoi t'as eu envie de le faire ?
Jenkins évolue vite (weekly, LTS tous les mois)

Mise à jour un peu pénibles

 * wget du war
 * cp / restart

L'occasion de jouer avec Docker de façon "utile".

== Raisons
// Et pourquoi t'as eu besoin de réinstaller un CI
Notre ancien serveur était sur les genoux.

Projets internes avec des stacks différentes.

Pas envie de pourrir la config système comme sur l'ancien.

== Archi cible
// Donc c'est quoi l'archi finale ?
//[graphviz]
--------
Host - [Docker]Jenkins -SSH- [Docker]Jenkins-slave
                       \SSH- [Docker]Jenkins-slave
--------

== Quickstart
// Ok, du coup comment on démarre ?
//Vu que le travail principal est fait, il suffit d'utiliser les bonnes images Docker
1. Docker Hub

2. Images préconfigurées

   * agileek/jenkins
   * evarga/jenkins-slave

== agileek/jenkins
//bitos pic
Maintenue par mbitard
//fork and knives
Fork de l'image officielle
//bleeding haxe
Bleeding edge

//is this relevant ?
//Montage du volume `JENKINS_HOME`

//Expose du port 8080

== evarga/jenkins-slave
Image avec OpenJDK7

Serveur SSH

Login `jenkins`/`jenkins`

//motor pic
== Gentlemen start your engines
[source,shell]
------
docker run -d -p 8080:8080 -v /home/jenkins:/var/jenkins_home agileek/jenkins
------

== Configuration Jenkins
Plugin Docker-Cloud

Configuration :
 
 * nom d'image
 * volumes montés

Utilisation des labels Jenkins

== Premier build

Ca marchera ...  pour un Hello World !

Maven télécharge internet, LENT

== Petit à petit 
// La personnalisation ? > check list
//comment personnaliser votre environnement?
//Prenez votre stack et listez ce qu'il faut installer
// Avec un exemple ? > pour nous 
[options="step"]
 * Détaillez votre stack 
 * Cherchez sur le registry
 * Construisez votre Dockerfile

== Aucard de Tours - Web
// Chez CT //// mettre le logo CT :) ////  on aime beaucoup restx, nos projets l'utilisant ont la stack suivante :@CT : Restx
image:ct/logo.png[] 


 * Git
 * Java 8 
// oui oui on fait du java 8 en prod !!
 * Maven
 * Sass/compass
 * npm
 * Bower
 * Grunt

== D.R.Y

Itération sur chaque élément pour se poser la question si une image "seule" est intéressante 

[options="step"]
 * Git X
 * Git + Java 8 Y
 * Git + Java 8 + Maven Y
 * Git + java 8 + Maven + sass N
 * Git + ... + Grunt Y

//En essayant de construire notre image, on a réussi a en faire trois en fait, qui pourront resservir 

Trois images résultats :

[options="step"]
 * jdk8
 * jdk8-mvn
 * jdk8-mvn-restx

== Aucard de Tours - Android
//et pour Android ?
Android SDK est lourd à installer,
// on a fait le taff avec des images.

[options="step"]
 * images pour le build
 * images pour l'émulation (qemu x86) 
//l'emulation nécessite de lancer les container en priviledged)
// on peut réutiliser vos images ? / Distribution sur DockerHub


== Points de douleurs
// T'as eu quoi comme problèmes ?
Le plugin Docker Jenkins est pas complétement sec

[options="step"]
 * configuration lourdingue
 * gestion des variables d'env difficile
 * pas de feedback rapide lors du pull des images 
//et ca peut prendre trois plombes)

Un peu de gymnastique supplémentaire pour être capable de faire du DinD (Docker in Docker)
-> Définir ce qui peut être éphémère
// cas du .m2/ .gradle si on veut des temps de build raisonnables
// warmup via un build pour peupler le .m2 / ou monter le volume
== Points de douleurs
 Registry central : 
 
[options="step"]
 * builds en erreurs.
 * recherche nulle

== Points de douleurs
Construction des Dockerfile
 
 * copier/coller 
 * trouver le bon "héritage"

== D.R.Y.ness
Beaucoup de copier / coller entre images

Projet en cours pour apporter des mixins

Pouvoir importer des fragments communs 

Dockerfile "composite"

http://github.com/CedricGatay/manifest-mixin

 * Cross platform (en Go comme Docker)
 * Très simple (mix'n merge)



== Ok, count me in
// Génial, comment je fais pareil ? 
=== Slides
  * http://github.com/CedricGatay/slides-template/tree/docker-jenkins-slave

=== Images

Accessibles sur 

 * http://github.com/code-troopers/docker-jenkins-slaves
 * https://registry.hub.docker.com/repos/codetroopers/

== Tips

== nginx en frontal

http://jenkins.code-troopers.com:8080 -> UGLY


Image nginx pour gérer les vhosts:
[options="step"]
 * jwilder/nginx-proxy
 * `docker run -d -e VIRTUAL_HOST=jenkins.code-troopers.com -e VIRTUAL_PORT=8080`

== Bénéfices

Notre serveur ne contient rien d'autre que le daemon Docker

On est hype !
//hipster pic

== Q&A